services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: Worker-Publish
    user: "1000:1000"
    ports:
      - "8015:80"
    volumes:
      - ../src:/app
    environment:
      - PHP_DISPLAY_ERRORS=1
      - PHP_MEMORY_LIMIT=512M
      - WEB_DOCUMENT_ROOT=/app/public
      - COMPOSER_VERSION=2
      - XDEBUG_MODE=coverage
      - LOG_CHANNEL=stderr
    working_dir: /app
    command: >
      bash -lc "
      if [ ! -f composer.json ]; then composer create-project --prefer-dist laravel/laravel .; fi
      && composer install
      && mkdir -p storage/framework/{sessions,views,cache/data}
      && chmod -R 775 storage bootstrap/cache
      && chown -R 1000:1000 storage bootstrap/cache
      && php artisan outbox:processor
      && supervisord
      "
    networks:
      - default
      - occurrence_shared

networks:
  occurrence_shared:
    external: true
    name: occurrence_shared